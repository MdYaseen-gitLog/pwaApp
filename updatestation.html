<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Station Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-6">
  <h1 class="text-3xl font-bold mb-6">ðŸš‰ Station Management</h1>

  <!-- FORM -->
  <div class="bg-white p-6 rounded shadow mb-8">
    <h2 class="text-xl font-semibold mb-4">Insert / Update Station</h2>

    <form id="stationForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <input id="stn_id" type="number" placeholder="Station ID" class="input" required />
      <input id="station_name" placeholder="Station Name" class="input" required />
      <input id="station_color" placeholder="Color" class="input" />

      <input id="layout" placeholder="Layout" class="input" />
      <input id="status" placeholder="Status" class="input" />
      <input id="location" placeholder="Location" class="input" />

      <input id="latitude" type="number" step="0.00000001" placeholder="Latitude" class="input" />
      <input id="longitude" type="number" step="0.00000001" placeholder="Longitude" class="input" />

      <input id="firstTrain" placeholder="First Train" class="input" />
      <input id="lastTrain" placeholder="Last Train" class="input" />
      <input id="frequency" placeholder="Frequency" class="input" />

      <input id="gateno" type="number" placeholder="Gate No" class="input" />
      <input id="gateinfo" placeholder="Gate Info" class="input" />
      <input id="facilities" placeholder="Facilities" class="input" />
      <input id="nearby" placeholder="Nearby" class="input" />

      <textarea id="description" placeholder="Description" class="input col-span-full"></textarea>

      <button class="col-span-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
        Save Station
      </button>
    </form>
  </div>

  <!-- SEARCH -->
  <input
    id="search"
    placeholder="ðŸ” Search station..."
    class="mb-4 w-full p-3 rounded border"
  />

  <!-- TABLE -->
  <div class="bg-white rounded shadow overflow-x-auto">
    <table class="w-full text-sm">
      <thead class="bg-gray-200">
        <tr>
          <th class="p-3 text-left">ID</th>
          <th class="p-3 text-left">Name</th>
          <th class="p-3 text-left">Location</th>
          <th class="p-3">Actions</th>
        </tr>
      </thead>
      <tbody id="stationTable"></tbody>
    </table>
  </div>

<script>
const API_BASE = "https://stninfo.yaseenmd965.workers.dev";
let stations = [];

const inputClass = document.querySelectorAll(".input");
inputClass.forEach(i => i.classList.add("p-2","border","rounded","w-full"));

async function loadStations() {
  const res = await fetch(`${API_BASE}/stations`);
  stations = await res.json();
  renderTable(stations);
}

function renderTable(data) {
  const tbody = document.getElementById("stationTable");
  tbody.innerHTML = "";

  data.forEach(s => {
    tbody.innerHTML += `
      <tr class="border-t hover:bg-gray-50">
        <td class="p-3">${s.stn_id}</td>
        <td class="p-3">${s.station_name}</td>
        <td class="p-3">${s.location || ""}</td>
        <td class="p-3 space-x-2 text-center">
          <button onclick='editStation(${JSON.stringify(s)})'
            class="bg-yellow-400 px-3 py-1 rounded">Edit</button>
          <button onclick="deleteStation(${s.stn_id})"
            class="bg-red-500 text-white px-3 py-1 rounded">Delete</button>
        </td>
      </tr>`;
  });
}

function editStation(s) {
  for (const key in s) {
    if (document.getElementById(key)) {
      document.getElementById(key).value = s[key] ?? "";
    }
  }
  window.scrollTo({ top: 0, behavior: "smooth" });
}

document.getElementById("stationForm").onsubmit = async e => {
  e.preventDefault();
  const stn_id = stn_idInput.value;

  const data = {};
  document.querySelectorAll("#stationForm input, textarea").forEach(el => {
    data[el.id] = el.value;
  });

  const method = confirm("Update station? OK = Update, Cancel = Insert") ? "PUT" : "POST";
  const url = method === "PUT"
    ? `${API_BASE}/stations/${stn_id}`
    : `${API_BASE}/stations`;

  await fetch(url, {
    method,
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });

  e.target.reset();
  loadStations();
};

async function deleteStation(id) {
  if (!confirm("Delete station " + id + "?")) return;
  await fetch(`${API_BASE}/stations/${id}`, { method: "DELETE" });
  loadStations();
}

document.getElementById("search").oninput = e => {
  const q = e.target.value.toLowerCase();
  renderTable(
    stations.filter(s =>
      String(s.stn_id).includes(q) ||
      s.station_name.toLowerCase().includes(q) ||
      (s.location || "").toLowerCase().includes(q)
    )
  );
};

const stn_idInput = document.getElementById("stn_id");
loadStations();
</script>
</body>
</html>
